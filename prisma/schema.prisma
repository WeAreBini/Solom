// Solom 2.0 Database Schema
// Multi-Agent AI Toolkit

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Council deliberations
model Council {
  id             String        @id @default(uuid())
  query          String
  status         CouncilStatus @default(PENDING)
  consensus      String?
  reasoningChain Json?         @map("reasoning_chain")
  confidence     Float?

  // Relations
  members CouncilMember[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("councils")
}

enum CouncilStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// Individual council members (agents)
model CouncilMember {
  id         String       @id @default(uuid())
  councilId  String       @map("council_id")
  agentName  AgentRole    @map("agent_name")
  status     MemberStatus @default(IDLE)
  findings   String?
  confidence Float?
  sources    Json?

  // Relations
  council Council @relation(fields: [councilId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")

  @@map("council_members")
}

enum AgentRole {
  RESEARCHER
  FACT_CHECKER
  CONTRARIAN
  SYNTHESIST
  EXECUTOR
}

enum MemberStatus {
  IDLE
  WORKING
  COMPLETE
  ERROR
}

// General task queue
model Task {
  id     String     @id @default(uuid())
  type   TaskType
  status TaskStatus @default(PENDING)
  input  Json
  output Json?
  error  String?

  // Timing
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("tasks")
}

enum TaskType {
  COUNCIL
  BROWSE
  FIREHOSE
  SYSTEM2
}

enum TaskStatus {
  PENDING
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// Browser automation sessions
model BrowserSession {
  id           String  @id @default(uuid())
  taskId       String  @map("task_id")
  playwrightId String? @map("playwright_id")

  // Session data
  screenshots String[]
  actionsLog  Json     @map("actions_log")
  finalUrl    String?  @map("final_url")

  createdAt DateTime  @default(now()) @map("created_at")
  closedAt  DateTime? @map("closed_at")

  @@map("browser_sessions")
}

// Firehose events (X/News streams)
model FirehoseEvent {
  id         String  @id @default(uuid())
  source     String // 'twitter', 'news', 'reddit'
  externalId String? @map("external_id")

  // Content
  author  String?
  content String
  url     String?

  // Analysis
  sentiment Float? // -1 to 1
  topics    String[]
  entities  Json?

  // Processing
  processed   Boolean   @default(false)
  processedAt DateTime? @map("processed_at")

  // Timestamps
  eventAt   DateTime @map("event_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("firehose_events")
}

// User portfolios for stock tracking
model UserPortfolio {
  id        String           @id @default(cuid())
  userId    String
  name      String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  stocks    PortfolioStock[]

  @@map("user_portfolios")
}

model PortfolioStock {
  id          String        @id @default(cuid())
  portfolioId String
  symbol      String
  shares      Float
  avgPrice    Float
  portfolio   UserPortfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@map("portfolio_stocks")
}

model Watchlist {
  id      String   @id @default(cuid())
  userId  String
  symbol  String
  addedAt DateTime @default(now())

  @@map("watchlists")
}

model UserSettings {
  id          String @id @default(cuid())
  userId      String @unique
  preferences Json

  @@map("user_settings")
}
